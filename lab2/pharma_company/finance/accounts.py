from dataclasses import dataclass
from typing import Optional, Dict
from pharma_company.exceptions import *

@dataclass
class УчётнаяЗапись:
    """Учётная запись пользователя системы."""
    логин: str
    хеш_пароля: str
    роль: str  # 'кассир', 'менеджер', 'аудитор', 'админ'
    активен: bool = True
    последняя_активность: Optional[str] = None

    def проверить_пароль(self, введённый_хеш: str) -> bool:
        """Проверяет соответствие хеша пароля."""
        if self.хеш_пароля != введённый_хеш:
            raise НеверныйПароль("Пароль неверен.")
        return True

    def проверить_право(self, операция: str) -> bool:
        """Проверка прав доступа по роли."""
        доступные = {
            "кассир": {"создать_продажу"},
            "менеджер": {"создать_продажу", "возврат", "коррекция_остатков"},
            "аудитор": {"просмотр_отчётов"},
            "админ": {"*"}
        }
        права = доступные.get(self.роль, set())
        if "*" in права or операция in права:
            return True
        raise НекорректныеПраваДоступа(f"Недостаточно прав для операции: {операция}")


@dataclass
class ПрофильПользователя:
    """Профиль пользователя для UI/систем."""
    учётная_запись: УчётнаяЗапись
    отображаемое_имя: str
    настройки: Dict[str, str]

    def обновить_имя(self, имя: str) -> None:
        """Обновляет отображаемое имя."""
        self.отображаемое_имя = имя

    def обновить_настройки(self, k: str, v: str) -> None:
        """Обновляет настройку."""
        self.настройки[k] = v


@dataclass
class Сессия:
    """Сессия пользователя в системе."""
    id: int
    учётная_запись: УчётнаяЗапись
    активна: bool = True
    токен: Optional[str] = None

    def завершить(self) -> None:
        """Завершает сессию."""
        self.активна = False

    def обновить_токен(self, t: str) -> None:
        """Обновляет токен."""
        self.токен = t
